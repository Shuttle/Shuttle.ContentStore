using System;
using System.IO;
using RestSharp;
using RestSharp.Extensions;
using Shuttle.Core.Contract;

namespace Shuttle.ContentStore.Opswat
{
    public class OpswatMalwareService : IMalwareService
    {
        private readonly IOpswatConfiguration _configuration;
        private readonly IOpswatApi _api;

        public OpswatMalwareService(IOpswatConfiguration configuration, IOpswatApi api)
        {
            Guard.AgainstNull(configuration, nameof(configuration));
            Guard.AgainstNull(api, nameof(api));

            _configuration = configuration;
            _api = api;
        }

        public ServiceStatus Register(Document document)
        {
            Guard.AgainstNull(document, nameof(document));

            var request = new RestRequest(_api.GetFullApiUrl("file"))
            {
                Method = Method.POST,
                RequestFormat = DataFormat.Json
            };

            request.AddFileBytes(document.FileName, document.Content, document.FileName, document.ContentType);

            if (!_configuration.SampleSharingAllowed)
            {
                request.AddHeader("samplesharing", "0");
            }

            request.AddHeader("rule", "sanitize");

            if (_configuration.ShouldSandbox(Path.GetExtension(document.FileName)))
            {
                request.AddHeader("sandbox", "windows10");
            }

            var response = _api.GetResponse(request).AsDynamic();

            GuardAgainstException(response);

            if (response.data_id == null)
            {
                throw new OpswatException($"Could not find data id for document with id '{document.Id}'.");
            }

            document.SetProperty("data_id", response.data_id.ToString());
            document.SetProperty("status", response.status.ToString());
            document.SetProperty("in_queue", response.in_queue.ToString());
            document.SetProperty("sha256", response.sha256.ToString());

            return ServiceStatus.Registered;
        }

        public ServiceStatus Poll(Document document)
        {
            Guard.AgainstNull(document, nameof(document));

            return !document.ContainsProperty("sandbox_id") ? PollScan(document) : PollSandbox(document);
        }

        private ServiceStatus PollSandbox(Document document)
        {
            var request = new RestRequest(_api.GetFullApiUrl($"sandbox/{document.GetSandboxId()}"))
            {
                Method = Method.GET,
                RequestFormat = DataFormat.Json
            };

            var response = _api.GetResponse(request).AsDynamic();

            GuardAgainstException(response);

            if (response.sandbox_response == null)
            {
                return ServiceStatus.Processing;
            }

            document.SetProperty("scan_all_result_i", response.scan_results.scan_all_result_i.ToString());
            document.SetProperty("scan_all_result_a", response.scan_results.scan_all_result_a.ToString());

            if (!int.TryParse(document.GetScanResult(), out var scanResult))
            {
                AddPollIntervalTimeSpan(document, _configuration.PollSandboxInterval);

                return ServiceStatus.Processing;
            }

            document.RemoveProperty("PollIntervalTimespan");

            return scanResult == 0 ? ServiceStatus.Cleared : ServiceStatus.Suspicious;
        }

        private ServiceStatus PollScan(Document document)
        {
            var request = new RestRequest(_api.GetFullApiUrl($"file/{document.GetDataId()}"))
            {
                Method = Method.GET,
                RequestFormat = DataFormat.Json
            };

            var response = _api.GetResponse(request).AsDynamic();

            GuardAgainstException(response);

            if (response.status != null)
            {
                document.SetProperty("status", response.status.ToString());
                document.SetProperty("in_queue", response.in_queue.ToString());
                document.SetProperty("last_updated", response.last_updated.ToString());

                AddPollIntervalTimeSpan(document, _configuration.PollScanInterval);

                return ServiceStatus.Processing;
            }

            try
            {
                document.SetProperty("scan_all_result_i", response.scan_results.scan_all_result_i.ToString());
                document.SetProperty("progress_percentage", response.scan_results.progress_percentage.ToString());
                document.SetProperty("scan_all_result_a", response.scan_results.scan_all_result_a.ToString());

                if (!int.TryParse(document.GetScanResult(), out var scanResult))
                {
                    scanResult = -1;
                }

                if (!double.TryParse(document.GetProgressPercentage(), out var progressPercentage))
                {
                    progressPercentage = -1;
                }

                if (progressPercentage < 100 || scanResult < 0)
                {
                    AddPollIntervalTimeSpan(document, _configuration.PollScanInterval);

                    return ServiceStatus.Processing;
                }

                if (scanResult > 0 && response.sanitized != null && !document.HasSanitizedContent)
                {
                    if (!double.TryParse(response.sanitized.progress_percentage.ToString(), out progressPercentage))
                    {
                        progressPercentage = -1;
                    }

                    if (progressPercentage < 100)
                    {
                        return ServiceStatus.Processing;
                    }

                    document.WithSanitizedContent(_api.GetResponse(new RestRequest(response.sanitized.file_path.ToString())).RawBytes);
                }

                document.RemoveProperty("status");
                document.RemoveProperty("in_queue");
                document.RemoveProperty("last_updated");
                document.RemoveProperty("PollIntervalTimespan");

                if (!_configuration.ShouldSandbox(Path.GetExtension(document.FileName)))
                {
                    return scanResult == 0 ? ServiceStatus.Cleared : ServiceStatus.Suspicious;
                }
            }
            catch (Exception ex)
            {
                throw new OpswatException($"Could not get scan results for document with id '{document.Id}'.", ex);
            }

            try
            {
                request = new RestRequest($"{_api.GetFullApiUrl("hash")}/{document.GetSha256()}/sandbox")
                {
                    Method = Method.GET,
                    RequestFormat = DataFormat.Json
                };

                response = _api.GetResponse(request).AsDynamic();

                if (response.sandbox_id != null)
                {
                    document.SetProperty("sandbox_id", response.sandbox_id.ToString());
                    document.SetProperty("scan_all_result_i", response.scan_results.scan_all_result_i.ToString());
                    document.SetProperty("scan_all_result_a", response.scan_results.scan_all_result_a.ToString());

                    if (!int.TryParse(document.GetScanResult(), out var scanResult))
                    {
                        AddPollIntervalTimeSpan(document, _configuration.PollSandboxInterval);

                        return ServiceStatus.Processing;
                    }

                    document.RemoveProperty("PollIntervalTimespan");

                    return scanResult == 0 ? ServiceStatus.Cleared : ServiceStatus.Suspicious;
                }
            }
            catch (Exception ex)
            {
                throw new OpswatException($"Could not retrieve sandbox hash lookup for document with id '{document.Id}'.", ex);
            }

            try
            {
                request = new RestRequest($"{_api.GetFullApiUrl("sandbox")}/{document.GetDataId()}/scan")
                {
                    Method = Method.POST,
                    RequestFormat = DataFormat.Json
                };

                request.AddHeader("sandbox", "windows10");

                response = _api.GetResponse(request).AsDynamic();

                GuardAgainstException(response);

                if (response.sandbox_id == null)
                {
                    throw new OpswatException($"Could not find sandbox id for document with id '{document.Id}'.");
                }

                document.SetProperty("sandbox_id", response.sandbox_id.ToString());

                AddPollIntervalTimeSpan(document, _configuration.PollSandboxInterval);

                return ServiceStatus.Processing;
            }
            catch (Exception ex)
            {
                throw new OpswatException($"Could not submit a sandbox request for document with id '{document.Id}'.", ex);
            }
        }

        private static void AddPollIntervalTimeSpan(Document document, TimeSpan interval)
        {
            document.SetProperty("PollIntervalTimespan", interval.ToString());
        }

        private static void GuardAgainstException(dynamic response)
        {
            if (response.error != null)
            {
                throw new OpswatException(string.Join(" / ", response.error.messages));
            }
        }
    }
}